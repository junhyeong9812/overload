<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${title}">Overload Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
<div class="container mx-auto px-4 py-8 max-w-4xl">

  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-green-400 mb-2">üöÄ Overload</h1>
    <p class="text-gray-400">Virtual Thread Load Testing Dashboard</p>
  </div>

  <!-- Request Configuration -->
  <div class="bg-gray-800 rounded-lg p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4 text-green-400">üìç Target</h2>

    <div class="flex gap-2 mb-4">
      <select id="method" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 w-28">
        <option value="GET">GET</option>
        <option value="POST">POST</option>
        <option value="PUT">PUT</option>
        <option value="DELETE">DELETE</option>
        <option value="PATCH">PATCH</option>
      </select>
      <input type="text" id="url"
             class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3"
             placeholder="https://api.example.com/users">
    </div>

    <div class="grid grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block text-sm text-gray-400 mb-2">Concurrency</label>
        <input type="number" id="concurrency"
               class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3"
               th:value="${defaults.concurrency}">
      </div>
      <div>
        <label class="block text-sm text-gray-400 mb-2">Total Requests</label>
        <input type="number" id="totalRequests"
               class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3"
               th:value="${defaults.requests}">
      </div>
    </div>

    <!-- Headers (collapsible) -->
    <details class="mb-4">
      <summary class="cursor-pointer text-gray-400 hover:text-white">Headers (JSON)</summary>
      <textarea id="headers"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 mt-2 h-20 font-mono text-sm"
                placeholder='{"Authorization": "Bearer xxx"}'></textarea>
    </details>

    <!-- Body (collapsible) -->
    <details class="mb-4">
      <summary class="cursor-pointer text-gray-400 hover:text-white">Request Body</summary>
      <textarea id="body"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 mt-2 h-24 font-mono text-sm"
                placeholder='{"name": "test"}'></textarea>
    </details>
  </div>

  <!-- Controls -->
  <div class="flex gap-4 mb-6">
    <button onclick="startTest()"
            id="startBtn"
            class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-4 rounded-lg font-semibold text-lg transition">
      ‚ñ∂ Run Load Test
    </button>
    <button onclick="stopTest()"
            id="stopBtn"
            class="bg-red-600 hover:bg-red-700 text-white px-6 py-4 rounded-lg font-semibold transition disabled:opacity-50"
            disabled>
      ‚¨õ Stop
    </button>
  </div>

  <!-- Progress -->
  <div class="bg-gray-800 rounded-lg p-6 mb-6">
    <div class="flex justify-between mb-2">
      <span class="text-gray-400">Progress</span>
      <span id="progressText" class="text-green-400 font-mono">0%</span>
    </div>
    <div class="w-full bg-gray-700 rounded-full h-4 mb-2">
      <div id="progressBar"
           class="bg-green-500 h-4 rounded-full transition-all duration-200"
           style="width: 0%"></div>
    </div>
    <div class="text-right text-sm text-gray-500">
      <span id="progressCount">0 / 0</span> requests
    </div>
  </div>

  <!-- Results -->
  <div id="results" class="bg-gray-800 rounded-lg p-6 hidden">
    <h2 class="text-xl font-semibold mb-4 text-green-400">üìä Results</h2>

    <div class="grid grid-cols-3 gap-4 mb-6">
      <div class="bg-gray-700 rounded-lg p-4 text-center">
        <div class="text-3xl font-bold text-green-400" id="rps">-</div>
        <div class="text-sm text-gray-400">Requests/sec</div>
      </div>
      <div class="bg-gray-700 rounded-lg p-4 text-center">
        <div class="text-3xl font-bold text-blue-400" id="avgLatency">-</div>
        <div class="text-sm text-gray-400">Avg Latency</div>
      </div>
      <div class="bg-gray-700 rounded-lg p-4 text-center">
        <div class="text-3xl font-bold text-yellow-400" id="successRate">-</div>
        <div class="text-sm text-gray-400">Success Rate</div>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div class="bg-gray-700 rounded-lg p-4">
        <h3 class="text-sm text-gray-400 mb-2">Requests</h3>
        <div class="space-y-1 text-sm">
          <div class="flex justify-between">
            <span>Total</span>
            <span id="totalReqs" class="font-mono">-</span>
          </div>
          <div class="flex justify-between">
            <span>Success</span>
            <span id="successReqs" class="font-mono text-green-400">-</span>
          </div>
          <div class="flex justify-between">
            <span>Failed</span>
            <span id="failedReqs" class="font-mono text-red-400">-</span>
          </div>
        </div>
      </div>
      <div class="bg-gray-700 rounded-lg p-4">
        <h3 class="text-sm text-gray-400 mb-2">Latency Percentiles</h3>
        <div class="space-y-1 text-sm">
          <div class="flex justify-between">
            <span>p50</span>
            <span id="p50" class="font-mono">-</span>
          </div>
          <div class="flex justify-between">
            <span>p90</span>
            <span id="p90" class="font-mono">-</span>
          </div>
          <div class="flex justify-between">
            <span>p99</span>
            <span id="p99" class="font-mono">-</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Status -->
  <div id="status" class="text-center text-gray-500 mt-4"></div>
</div>

<script th:inline="javascript">
  const basePath = /*[[${basePath}]]*/ '/overload';
  let currentTestId = null;
  let ws = null;

  function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${window.location.host}${basePath}/ws`);

    ws.onmessage = function(event) {
      const data = JSON.parse(event.data);
      if (data.testId === currentTestId) {
        updateProgress(data);
      }
    };

    ws.onclose = function() {
      setTimeout(connectWebSocket, 3000);
    };

    ws.onerror = function() {
      setStatus('WebSocket error', 'red');
    };
  }

  function startTest() {
    const url = document.getElementById('url').value.trim();
    if (!url) {
      setStatus('Please enter a URL', 'red');
      return;
    }

    const request = {
      url: url,
      method: document.getElementById('method').value,
      concurrency: parseInt(document.getElementById('concurrency').value) || 10,
      totalRequests: parseInt(document.getElementById('totalRequests').value) || 100,
      headers: parseJson(document.getElementById('headers').value),
      body: document.getElementById('body').value || null
    };

    setStatus('Starting test...', 'yellow');
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('results').classList.add('hidden');
    updateProgressBar(0, request.totalRequests);

    fetch(`${basePath}/api/tests`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(request)
    })
    .then(res => res.json())
    .then(data => {
      currentTestId = data.testId;
      setStatus(`Test ${currentTestId} running...`, 'green');
    })
    .catch(err => {
      setStatus('Failed to start test: ' + err.message, 'red');
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    });
  }

  function stopTest() {
    if (currentTestId) {
      fetch(`${basePath}/api/tests/${currentTestId}`, {method: 'DELETE'})
      .then(() => setStatus('Test cancelled', 'yellow'));
    }
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
  }

  function updateProgress(data) {
    updateProgressBar(data.completed, data.total);

    if (data.status === 'COMPLETED') {
      setStatus('Test completed!', 'green');
      fetchResults();
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    } else if (data.status === 'FAILED') {
      setStatus('Test failed', 'red');
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    } else if (data.status === 'CANCELLED') {
      setStatus('Test cancelled', 'yellow');
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    }
  }

  function updateProgressBar(completed, total) {
    const percent = total > 0 ? (completed / total * 100).toFixed(1) : 0;
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressText').textContent = percent + '%';
    document.getElementById('progressCount').textContent =
        `${completed.toLocaleString()} / ${total.toLocaleString()}`;
  }

  function fetchResults() {
    fetch(`${basePath}/api/tests/${currentTestId}`)
    .then(res => res.json())
    .then(data => {
      if (data.result) {
        displayResults(data.result);
      }
    });
  }

  function displayResults(result) {
    document.getElementById('rps').textContent = result.requestsPerSecond.toFixed(2);
    document.getElementById('avgLatency').textContent = result.latencyStats.avg.toFixed(0) + 'ms';
    document.getElementById('successRate').textContent = result.successRate.toFixed(1) + '%';

    document.getElementById('totalReqs').textContent = result.totalRequests.toLocaleString();
    document.getElementById('successReqs').textContent = result.successCount.toLocaleString();
    document.getElementById('failedReqs').textContent = result.failCount.toLocaleString();

    document.getElementById('p50').textContent = result.latencyStats.percentiles.p50 + 'ms';
    document.getElementById('p90').textContent = result.latencyStats.percentiles.p90 + 'ms';
    document.getElementById('p99').textContent = result.latencyStats.percentiles.p99 + 'ms';

    document.getElementById('results').classList.remove('hidden');
  }

  function setStatus(message, color) {
    const el = document.getElementById('status');
    el.textContent = message;
    el.className = 'text-center mt-4 text-' + color + '-400';
  }

  function parseJson(str) {
    try {
      return str ? JSON.parse(str) : null;
    } catch {
      return null;
    }
  }

  // Initialize
  connectWebSocket();
</script>
</body>
</html>
