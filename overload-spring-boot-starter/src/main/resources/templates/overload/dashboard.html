<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${title}">Overload Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card-collapsed { max-height: 60px; overflow: hidden; }
    .card-expanded { max-height: 2000px; }
    .log-scroll { max-height: 200px; overflow-y: auto; }
    .progress-ring { transform: rotate(-90deg); }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
<div class="container mx-auto px-4 py-8 max-w-5xl">

  <!-- Header -->
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-3xl font-bold text-green-400">üöÄ Overload</h1>
      <p class="text-gray-400 text-sm">Virtual Thread Load Testing Dashboard</p>
    </div>
    <button onclick="addNewTest()"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2">
      <span>+</span> New Test
    </button>
  </div>

  <!-- Test Cards Container -->
  <div id="testCards" class="space-y-4">
    <!-- Cards will be dynamically added here -->
  </div>

  <!-- Empty State -->
  <div id="emptyState" class="text-center py-16 text-gray-500">
    <div class="text-6xl mb-4">üìä</div>
    <p class="text-xl mb-4">No active tests</p>
    <button onclick="addNewTest()"
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition">
      Start Your First Test
    </button>
  </div>

</div>

<!-- Card Template -->
<template id="cardTemplate">
  <div class="test-card bg-gray-800 rounded-lg overflow-hidden transition-all duration-300" data-test-id="">
    <!-- Collapsed Header (Always Visible) -->
    <div class="card-header flex items-center gap-4 p-4 cursor-pointer" onclick="toggleCard(this)">
      <!-- Status Indicator -->
      <div class="status-ring flex-shrink-0">
        <svg class="w-12 h-12" viewBox="0 0 36 36">
          <circle cx="18" cy="18" r="15.5" fill="none" stroke="#374151" stroke-width="3"/>
          <circle class="progress-circle progress-ring" cx="18" cy="18" r="15.5" fill="none"
                  stroke="#22c55e" stroke-width="3" stroke-dasharray="0 100"
                  stroke-linecap="round"/>
          <text x="18" y="20" text-anchor="middle" class="text-xs fill-current" style="font-size: 8px;">0%</text>
        </svg>
      </div>

      <!-- Test Info -->
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2">
          <span class="method-badge bg-blue-600 text-xs px-2 py-0.5 rounded font-mono">GET</span>
          <span class="url-display text-sm font-mono truncate text-gray-300">-</span>
        </div>
        <div class="text-xs text-gray-500 mt-1">
          <span class="completed-count">0</span> / <span class="total-count">0</span> requests
        </div>
      </div>

      <!-- Action Button -->
      <div class="flex-shrink-0">
        <button class="action-btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-semibold transition">
          ‚ñ∂ Run
        </button>
      </div>

      <!-- Expand/Collapse Icon -->
      <div class="expand-icon text-gray-500 transition-transform duration-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </div>
    </div>

    <!-- Expanded Content -->
    <div class="card-body border-t border-gray-700 p-4 hidden">
      <!-- Configuration -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div class="space-y-3">
          <div class="flex gap-2">
            <select class="method-select bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm w-24">
              <option value="GET">GET</option>
              <option value="POST">POST</option>
              <option value="PUT">PUT</option>
              <option value="DELETE">DELETE</option>
              <option value="PATCH">PATCH</option>
            </select>
            <input type="text" class="url-input flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm"
                   placeholder="http://localhost:8080/api/test">
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs text-gray-400 mb-1">Concurrency</label>
              <input type="number" class="concurrency-input w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm"
                     th:value="${defaults.concurrency}">
            </div>
            <div>
              <label class="block text-xs text-gray-400 mb-1">Total Requests</label>
              <input type="number" class="requests-input w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm"
                     th:value="${defaults.requests}">
            </div>
          </div>
        </div>

        <div class="space-y-2">
          <details>
            <summary class="text-xs text-gray-400 cursor-pointer hover:text-white">Headers (JSON)</summary>
            <textarea class="headers-input w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-xs font-mono mt-1 h-16"
                      placeholder='{"Authorization": "Bearer xxx"}'></textarea>
          </details>
          <details>
            <summary class="text-xs text-gray-400 cursor-pointer hover:text-white">Request Body</summary>
            <textarea class="body-input w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-xs font-mono mt-1 h-16"
                      placeholder='{"name": "test"}'></textarea>
          </details>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="mb-4">
        <div class="flex justify-between text-xs text-gray-400 mb-1">
          <span>Progress</span>
          <span class="progress-text">0%</span>
        </div>
        <div class="w-full bg-gray-700 rounded-full h-2">
          <div class="progress-bar bg-green-500 h-2 rounded-full transition-all duration-200" style="width: 0%"></div>
        </div>
      </div>

      <!-- Live Request Logs -->
      <div class="mb-4">
        <div class="flex justify-between items-center mb-2">
          <span class="text-xs text-gray-400">üìã Live Requests</span>
          <button class="clear-logs-btn text-xs text-gray-500 hover:text-white">Clear</button>
        </div>
        <div class="log-scroll bg-gray-900 rounded p-2 font-mono text-xs space-y-1">
          <div class="log-empty text-gray-600 text-center py-4">No requests yet</div>
        </div>
      </div>

      <!-- Results (Hidden until complete) -->
      <div class="results-section hidden">
        <div class="text-xs text-gray-400 mb-2">üìä Results</div>
        <div class="grid grid-cols-3 gap-2 mb-3">
          <div class="bg-gray-700 rounded p-3 text-center">
            <div class="text-xl font-bold text-green-400 rps-value">-</div>
            <div class="text-xs text-gray-400">req/s</div>
          </div>
          <div class="bg-gray-700 rounded p-3 text-center">
            <div class="text-xl font-bold text-blue-400 latency-value">-</div>
            <div class="text-xs text-gray-400">avg ms</div>
          </div>
          <div class="bg-gray-700 rounded p-3 text-center">
            <div class="text-xl font-bold text-yellow-400 success-rate-value">-</div>
            <div class="text-xs text-gray-400">success</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2 text-xs">
          <div class="bg-gray-700 rounded p-2">
            <div class="flex justify-between"><span class="text-gray-400">Total</span><span class="total-reqs">-</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Success</span><span class="text-green-400 success-reqs">-</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Failed</span><span class="text-red-400 failed-reqs">-</span></div>
          </div>
          <div class="bg-gray-700 rounded p-2">
            <div class="flex justify-between"><span class="text-gray-400">p50</span><span class="p50-value">-</span></div>
            <div class="flex justify-between"><span class="text-gray-400">p90</span><span class="p90-value">-</span></div>
            <div class="flex justify-between"><span class="text-gray-400">p99</span><span class="p99-value">-</span></div>
          </div>
        </div>
      </div>

      <!-- Card Actions -->
      <div class="flex justify-end gap-2 mt-4 pt-4 border-t border-gray-700">
        <button class="delete-btn text-gray-500 hover:text-red-400 text-sm px-3 py-1">üóëÔ∏è Remove</button>
      </div>
    </div>
  </div>
</template>

<script th:inline="javascript">
  const basePath = /*[[${basePath}]]*/ '/overload';
  const defaultConcurrency = /*[[${defaults.concurrency}]]*/ 10;
  const defaultRequests = /*[[${defaults.requests}]]*/ 100;

  let tests = new Map();
  let cardCounter = 0;
  let ws = null;

  document.addEventListener('DOMContentLoaded', () => {
    connectWebSocket();
    loadActiveTests();
  });

  function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${window.location.host}${basePath}/ws`);

    ws.onmessage = function(event) {
      const data = JSON.parse(event.data);
      updateTestProgress(data);
    };

    ws.onclose = function() {
      setTimeout(connectWebSocket, 3000);
    };
  }

  function loadActiveTests() {
    fetch(`${basePath}/api/tests/active`)
    .then(res => res.json())
    .then(activeTests => {
      if (activeTests.length === 0) {
        updateEmptyState();
      } else {
        activeTests.forEach(test => {
          if (!tests.has(test.testId)) {
            const card = createTestCard();
            card.dataset.testId = test.testId;
            tests.set(test.testId, {
              cardId: card.id,
              status: test.status,
              url: test.url,
              method: test.method
            });
            updateCardFromServer(card, test);
          }
        });
      }
    })
    .catch(() => updateEmptyState());
  }

  function addNewTest() {
    const card = createTestCard();
    updateEmptyState();
    const body = card.querySelector('.card-body');
    body.classList.remove('hidden');
    card.querySelector('.expand-icon').style.transform = 'rotate(180deg)';
    setTimeout(() => card.querySelector('.url-input').focus(), 100);
  }

  function createTestCard() {
    const template = document.getElementById('cardTemplate');
    const card = template.content.cloneNode(true).querySelector('.test-card');
    card.id = `card-${++cardCounter}`;

    card.querySelector('.concurrency-input').value = defaultConcurrency;
    card.querySelector('.requests-input').value = defaultRequests;

    setupCardListeners(card);

    document.getElementById('testCards').appendChild(card);
    return card;
  }

  function setupCardListeners(card) {
    const actionBtn = card.querySelector('.action-btn');
    const deleteBtn = card.querySelector('.delete-btn');
    const clearLogsBtn = card.querySelector('.clear-logs-btn');
    const urlInput = card.querySelector('.url-input');
    const methodSelect = card.querySelector('.method-select');

    actionBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      handleAction(card);
    });

    deleteBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      removeCard(card);
    });

    clearLogsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      clearLogs(card);
    });

    urlInput.addEventListener('input', () => updateCardHeader(card));
    methodSelect.addEventListener('change', () => updateCardHeader(card));
  }

  function toggleCard(header) {
    const card = header.closest('.test-card');
    const body = card.querySelector('.card-body');
    const icon = card.querySelector('.expand-icon');

    body.classList.toggle('hidden');
    icon.style.transform = body.classList.contains('hidden') ? '' : 'rotate(180deg)';
  }

  function handleAction(card) {
    const testId = card.dataset.testId;
    const status = tests.get(testId)?.status;

    if (status === 'RUNNING') {
      stopTest(card);
    } else if (status === 'COMPLETED' || status === 'FAILED' || status === 'CANCELLED') {
      viewResults(card);
    } else {
      startTest(card);
    }
  }

  function startTest(card) {
    const url = card.querySelector('.url-input').value.trim();
    if (!url) {
      alert('Please enter a URL');
      return;
    }

    const request = {
      url: url,
      method: card.querySelector('.method-select').value,
      concurrency: parseInt(card.querySelector('.concurrency-input').value) || defaultConcurrency,
      totalRequests: parseInt(card.querySelector('.requests-input').value) || defaultRequests,
      headers: parseJson(card.querySelector('.headers-input').value),
      body: card.querySelector('.body-input').value || null
    };

    updateCardHeader(card);
    setCardStatus(card, 'STARTING');
    card.querySelector('.total-count').textContent = request.totalRequests.toLocaleString();

    fetch(`${basePath}/api/tests`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(request)
    })
    .then(res => res.json())
    .then(data => {
      card.dataset.testId = data.testId;
      tests.set(data.testId, {
        cardId: card.id,
        status: 'RUNNING',
        url: request.url,
        method: request.method
      });
      setCardStatus(card, 'RUNNING');
    })
    .catch(err => {
      setCardStatus(card, 'FAILED');
      alert('Failed to start test: ' + err.message);
    });
  }

  function stopTest(card) {
    const testId = card.dataset.testId;
    if (testId) {
      fetch(`${basePath}/api/tests/${testId}`, {method: 'DELETE'});
    }
  }

  function viewResults(card) {
    const body = card.querySelector('.card-body');
    if (body.classList.contains('hidden')) {
      toggleCard(card.querySelector('.card-header'));
    }
    card.querySelector('.results-section').scrollIntoView({behavior: 'smooth'});
  }

  function updateTestProgress(data) {
    const testState = tests.get(data.testId);
    if (!testState) return;

    const card = document.getElementById(testState.cardId);
    if (!card) return;

    const percent = data.total > 0 ? (data.completed / data.total * 100) : 0;
    updateProgressUI(card, percent, data.completed, data.total);

    if (data.recentLogs && data.recentLogs.length > 0) {
      updateLogs(card, data.recentLogs);
    }

    testState.status = data.status;
    setCardStatus(card, data.status);

    if (data.status === 'COMPLETED') {
      fetchResults(card, data.testId);
    }
  }

  function updateProgressUI(card, percent, completed, total) {
    card.querySelector('.progress-bar').style.width = percent + '%';
    card.querySelector('.progress-text').textContent = percent.toFixed(1) + '%';

    const circle = card.querySelector('.progress-circle');
    const circumference = 2 * Math.PI * 15.5;
    const offset = circumference - (percent / 100) * circumference;
    circle.setAttribute('stroke-dasharray', `${circumference - offset} ${offset}`);

    const ringText = card.querySelector('.status-ring text');
    ringText.textContent = Math.round(percent) + '%';

    card.querySelector('.completed-count').textContent = completed.toLocaleString();
    card.querySelector('.total-count').textContent = total.toLocaleString();
  }

  function updateLogs(card, logs) {
    const logContainer = card.querySelector('.log-scroll');
    const emptyMsg = logContainer.querySelector('.log-empty');
    if (emptyMsg) emptyMsg.remove();

    while (logContainer.children.length > 50) {
      logContainer.lastChild.remove();
    }

    logs.reverse().forEach(log => {
      const existingLog = logContainer.querySelector(`[data-req="${log.requestNumber}"]`);
      if (existingLog) return;

      const logEl = document.createElement('div');
      logEl.dataset.req = log.requestNumber;
      logEl.className = 'flex items-center gap-2 py-0.5';

      const icon = log.success ? '‚úÖ' : '‚ùå';
      const statusClass = log.success ? 'text-green-400' : 'text-red-400';
      const statusText = log.success ? log.statusCode : 'ERR';
      const errorText = log.error ? ` - ${log.error.substring(0, 30)}` : '';

      logEl.innerHTML = `
        <span class="text-gray-500 w-12">#${log.requestNumber}</span>
        <span>${icon}</span>
        <span class="${statusClass} w-12">${statusText}</span>
        <span class="text-gray-400 w-16">${log.latencyMs}ms</span>
        <span class="text-gray-600 truncate text-xs">${errorText}</span>
      `;

      logContainer.insertBefore(logEl, logContainer.firstChild);
    });
  }

  function clearLogs(card) {
    const logContainer = card.querySelector('.log-scroll');
    logContainer.innerHTML = '<div class="log-empty text-gray-600 text-center py-4">No requests yet</div>';
  }

  function fetchResults(card, testId) {
    fetch(`${basePath}/api/tests/${testId}`)
    .then(res => res.json())
    .then(data => {
      if (data.result) {
        displayResults(card, data.result);
      }
    });
  }

  function displayResults(card, result) {
    card.querySelector('.rps-value').textContent = result.requestsPerSecond.toFixed(1);
    card.querySelector('.latency-value').textContent = result.latencyStats.avg.toFixed(0);
    card.querySelector('.success-rate-value').textContent = result.successRate.toFixed(1) + '%';

    card.querySelector('.total-reqs').textContent = result.totalRequests.toLocaleString();
    card.querySelector('.success-reqs').textContent = result.successCount.toLocaleString();
    card.querySelector('.failed-reqs').textContent = result.failCount.toLocaleString();

    card.querySelector('.p50-value').textContent = result.latencyStats.percentiles.p50 + 'ms';
    card.querySelector('.p90-value').textContent = result.latencyStats.percentiles.p90 + 'ms';
    card.querySelector('.p99-value').textContent = result.latencyStats.percentiles.p99 + 'ms';

    card.querySelector('.results-section').classList.remove('hidden');
  }

  function setCardStatus(card, status) {
    const btn = card.querySelector('.action-btn');
    const circle = card.querySelector('.progress-circle');

    switch (status) {
      case 'STARTING':
        btn.textContent = '‚è≥ Starting...';
        btn.disabled = true;
        btn.className = 'action-btn bg-gray-600 text-white px-4 py-2 rounded text-sm font-semibold';
        break;
      case 'RUNNING':
        btn.textContent = '‚¨õ Stop';
        btn.disabled = false;
        btn.className = 'action-btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm font-semibold transition';
        circle.setAttribute('stroke', '#22c55e');
        break;
      case 'COMPLETED':
        btn.textContent = 'üìä Results';
        btn.disabled = false;
        btn.className = 'action-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-semibold transition';
        circle.setAttribute('stroke', '#22c55e');
        break;
      case 'FAILED':
        btn.textContent = '‚ùå Failed';
        btn.disabled = false;
        btn.className = 'action-btn bg-red-800 text-white px-4 py-2 rounded text-sm font-semibold';
        circle.setAttribute('stroke', '#ef4444');
        break;
      case 'CANCELLED':
        btn.textContent = '‚ñ∂ Retry';
        btn.disabled = false;
        btn.className = 'action-btn bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded text-sm font-semibold transition';
        circle.setAttribute('stroke', '#eab308');
        break;
      default:
        btn.textContent = '‚ñ∂ Run';
        btn.disabled = false;
        btn.className = 'action-btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-semibold transition';
    }
  }

  function updateCardHeader(card) {
    const url = card.querySelector('.url-input').value || '-';
    const method = card.querySelector('.method-select').value;

    card.querySelector('.url-display').textContent = url;
    card.querySelector('.method-badge').textContent = method;

    const badge = card.querySelector('.method-badge');
    const colors = {
      GET: 'bg-blue-600',
      POST: 'bg-green-600',
      PUT: 'bg-yellow-600',
      DELETE: 'bg-red-600',
      PATCH: 'bg-purple-600'
    };
    badge.className = `method-badge ${colors[method] || 'bg-gray-600'} text-xs px-2 py-0.5 rounded font-mono`;
  }

  function updateCardFromServer(card, test) {
    card.querySelector('.url-input').value = test.url || '';
    card.querySelector('.method-select').value = test.method || 'GET';
    updateCardHeader(card);
    updateProgressUI(card, test.percentage || 0, test.completed || 0, test.total || 0);
    setCardStatus(card, test.status);
  }

  function removeCard(card) {
    const testId = card.dataset.testId;
    if (testId && tests.get(testId)?.status === 'RUNNING') {
      if (!confirm('Test is still running. Stop and remove?')) return;
      stopTest(card);
    }
    tests.delete(testId);
    card.remove();
    updateEmptyState();
  }

  function updateEmptyState() {
    const emptyState = document.getElementById('emptyState');
    const hasCards = document.getElementById('testCards').children.length > 0;
    emptyState.classList.toggle('hidden', hasCards);
  }

  function parseJson(str) {
    try {
      return str ? JSON.parse(str) : null;
    } catch {
      return null;
    }
  }
</script>
</body>
</html>